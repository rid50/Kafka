import { Injectable } from '@angular/core';
import { Client } from '@stomp/stompjs'; // Use Client from @stomp/stompjs for modern Angular
import * as SockJS from 'sockjs-client';

@Injectable({
  providedIn: 'root'
})
export class WebSocketService {
  private stompClient: Client;
  // Define your backend WebSocket URL here
  private serverUrl = 'http://localhost:8080/your-websocket-endpoint';

  constructor() {}

  public connect(): Promise<Client> {
    return new Promise((resolve, reject) => {
      // Use a function that returns a new SockJS object
      this.stompClient = new Client({
        webSocketFactory: () => {
          return new SockJS(this.serverUrl) as WebSocket;
        },
        onConnect: (frame) => {
          console.log('Connected: ' + frame);
          resolve(this.stompClient);
        },
        onStompError: (frame) => {
          console.error('Broker reported error: ' + frame.headers['message']);
          console.error('Additional details: ' + frame.body);
          reject(frame);
        }
      });

      this.stompClient.activate();
    });
  }

  // Add methods for subscribe and send
  public subscribe(destination: string, callback: (message: any) => any): void {
    this.stompClient.subscribe(destination, callback);
  }

  public send(destination: string, body: string): void {
    this.stompClient.publish({ destination, body });
  }
}
